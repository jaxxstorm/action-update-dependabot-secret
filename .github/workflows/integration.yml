name: "Integration Tests"

on:
  pull_request:
  workflow_dispatch:
  push:
    branches:
      - main
      - "releases/*"

# Note: The default GITHUB_TOKEN does not have the 'dependabot_secrets' permission.
# You need to provide a token with this permission (PAT or GitHub App token).
# Add a repository secret named DEPENDABOT_SECRETS_TOKEN with the required permissions.
# See: https://docs.github.com/en/rest/dependabot/secrets

jobs:
  test-secret-lifecycle:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          cache: "npm"
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build action
        run: npm run build
      
      - name: Create/Update test secret
        uses: ./
        with:
          token: ${{ secrets.DEPENDABOT_SECRETS_TOKEN }}
          owner: ${{ github.repository_owner }}
          repo: ${{ github.event.repository.name }}
          secret_name: INTEGRATION_TEST_SECRET
          secret_value: test-value-${{ github.sha }}-${{ github.run_id }}
      
      - name: Verify secret was created
        run: |
          RESPONSE=$(curl -L \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.DEPENDABOT_SECRETS_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/${{ github.repository_owner }}/${{ github.event.repository.name }}/dependabot/secrets/INTEGRATION_TEST_SECRET)
          
          echo "$RESPONSE"
          
          # Check if the secret exists (the API returns the secret name and created/updated timestamps)
          if echo "$RESPONSE" | grep -q '"name".*"INTEGRATION_TEST_SECRET"'; then
            echo "✓ Secret verified successfully"
          else
            echo "✗ Secret verification failed"
            exit 1
          fi
      
      - name: Delete test secret
        if: always()
        run: |
          curl -L \
            -X DELETE \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.DEPENDABOT_SECRETS_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/${{ github.repository_owner }}/${{ github.event.repository.name }}/dependabot/secrets/INTEGRATION_TEST_SECRET
          
          echo "✓ Test secret deleted"
